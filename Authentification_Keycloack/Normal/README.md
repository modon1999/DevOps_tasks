<h2>Данный плейбук с ролями созданы для развертывания на ОС под управлением Ubuntu/Debian Keycloak на базе БД PostgreSQL, с созданием сертификата с помощью Let's Encrypt.</h2>

<h3>Version 0.1.0 31.03.2023 Исполнитель: Григорьев Н.С.</h3>
Реализована первая рабочая версия, на данный момент доступно только разворачивание базы данных и Keycloak на одним хосте. Важное примечание: первичную инициализацию силами доступных инструментов неудалось реализовать, в силу ограничений платформы Keycloak 21.0.1(инициализировать администратора после установки можно либо с помощью переменных среды либо с помощью обращения по localhost, за подробностями обращаться к исполнителю), поэтому реализована начальная инициализация Keycloak с помощью backup БД только инициализированного Keycloak, в дальнейшем можно переиспользовать это для восстановления работоспособности сервера из бэкапа его БД.

<h3>Назначение ролей:</h3>

  * install_postgresql_14 - данная роль устанавливает PostgreSQL-14 на ОС под управлением Ubuntu/Debian;
  * prepar_postgre_for_keyclok - данная роль создает в PostgreSQL пользователя и базу данных для Keyclok, после чего восстанавливает backup базу данных Keyclok, тем самым мы можем восстановить, в случае неполадок, Keyclok из backup БД, так как все данные Keyclok хранит в используемой базе данных;
  * create_cert_lets_encrypt - данная роль устанавливает certbot на ОС под управлением Ubuntu/Debian и создает сертификат на домен;
  * install_keycloak - данная роль устанавливает на ОС Ubuntu/Debian Keycloak.

<h3>Используемые переменные:</h3>

  * db_user - пользователь в БД для Keycloak.
  * db_user_passwd - пароль для пользователя в БД для Keycloak.
  * db_name - имя БД для Keycloak.
  * domain - используемый домен.
  * https_port - порт который будет прослушивать Keycloak для ответа по HTTPS(HTTP выключен).
  * email - email при создании сертификата на Lets Encrypt.

<h3>Примечание: в самом плейбуке значение переменных можно зашифровать с помощью ansible vault, или другими доступными способами.</h3>

---------------------------------------------------------------------------------------------------------------------------------------------------------------------
<h3>Инструкция по применению:</h3>

1. Установите ansible(требования: ОС Linux, Python 2.6+ или 3.5+).
2. Создать директорию для проекта(например, mkdir ansible) и перейти в неё.
3. Скопировать данный репозиторий в эту директорию(git clone https://srv.secdev.space/griganik/deploy_keycloak.git), и переходите в склонированную директорию deploy_keycloak.
5. Настраиваем соединение с рабочими узлами:
   * В файле hosts.txt меняем ip на ip хоста, где будет развернут keycloak(ansible_host=192.168.20.190).
   * Также меняем пользователя от имени которого мы подключимся по ssh к хосту, где будет развернут keycloak(ansible_user=user).
   * Устанавливаем аутентификацию ssh по паролю(apt-get install sshpass).
   * Проверяем соединение с хостом: ansible keycloak -m ping -k и когда попросит вводим пароль пользователя.
6. Запускаем playbook: ansible-playbook deploy_keycloak.yaml -k -K, сначала вас попросит ввести пароль пользователя, а затем пароль на использование этим пользователем sudo, вы также можете переназначить перечисленные выше переменные в соответствии с вашими требованиями с помощь параметра --extra-vars:
   * ansible-playbook deploy_keycloak.yaml -k -K --extra-vars "db_user=admin db_user_passwd=qwerty123456 domain=example.com"
